services:
  mongodb:
    image: mongo:6
    restart: unless-stopped
    command: mongod --oplogSize 128 --replSet rs0
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER:-root}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD:-rocketchat}
    volumes:
      - mongodb-data:/data/db
      - mongodb-config:/data/configdb
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  mongodb-init-replica:
    image: mongo:6
    depends_on:
      mongodb:
        condition: service_healthy
    command: >
      mongosh --host mongodb:27017 -u ${MONGO_USER:-root} -p ${MONGO_PASSWORD:-rocketchat}
      --eval "rs.initiate({_id: 'rs0', members: [{_id: 0, host: 'mongodb:27017'}]})"
    restart: "no"

  rocketchat:
    image: rocketchat/rocket.chat:latest
    restart: unless-stopped
    depends_on:
      mongodb:
        condition: service_healthy
      mongodb-init-replica:
        condition: service_completed_successfully
    environment:
      # MongoDB
      MONGO_URL: mongodb://${MONGO_USER:-root}:${MONGO_PASSWORD:-rocketchat}@mongodb:27017/rocketchat?replicaSet=rs0&directConnection=true
      MONGO_OPLOG_URL: mongodb://${MONGO_USER:-root}:${MONGO_PASSWORD:-rocketchat}@mongodb:27017/local?replicaSet=rs0&directConnection=true

      # Server
      ROOT_URL: ${ROOT_URL:-http://localhost:3000}
      PORT: 3000

      # Admin
      ADMIN_USERNAME: ${ADMIN_USERNAME:-admin}
      ADMIN_NAME: ${ADMIN_NAME:-Administrator}
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@example.com}
      ADMIN_PASS: ${ADMIN_PASS:-}

      # Optional: SMTP
      MAIL_URL: ${MAIL_URL:-}

      # Optional: Features
      OVERWRITE_SETTING_Show_Setup_Wizard: ${SHOW_SETUP_WIZARD:-completed}

    ports:
      - "${PORT:-3000}:3000"
    volumes:
      - rocketchat-uploads:/app/uploads

volumes:
  mongodb-data:
  mongodb-config:
  rocketchat-uploads:
