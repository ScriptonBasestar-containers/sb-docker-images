# Taiga - Agile Project Management Platform
# https://www.taiga.io/
#
# This compose file uses official Taiga Docker images from Kaleidos
# See: https://github.com/kaleidos-ventures/taiga-docker

x-environment: &taiga-env
  # Database
  POSTGRES_DB: ${TAIGA_DB_NAME:-taiga}
  POSTGRES_USER: ${TAIGA_DB_USER:-taiga}
  POSTGRES_PASSWORD: ${TAIGA_DB_PASSWORD:-taiga_password}
  # URLs
  TAIGA_SCHEME: ${TAIGA_SCHEME:-http}
  TAIGA_DOMAIN: ${TAIGA_DOMAIN:-localhost:9000}
  TAIGA_SUBPATH: ${TAIGA_SUBPATH:-}
  # Email (optional)
  EMAIL_BACKEND: ${EMAIL_BACKEND:-console}
  DEFAULT_FROM_EMAIL: ${DEFAULT_FROM_EMAIL:-no-reply@example.com}
  # Telemetry
  ENABLE_TELEMETRY: ${ENABLE_TELEMETRY:-False}
  # Secret key (CHANGE IN PRODUCTION!)
  TAIGA_SECRET_KEY: ${TAIGA_SECRET_KEY:-taiga-secret-key-change-me}
  # Public registration
  PUBLIC_REGISTER_ENABLED: ${PUBLIC_REGISTER_ENABLED:-False}

services:
  taiga-db:
    image: postgres:15-alpine
    container_name: taiga-db
    environment:
      POSTGRES_DB: ${TAIGA_DB_NAME:-taiga}
      POSTGRES_USER: ${TAIGA_DB_USER:-taiga}
      POSTGRES_PASSWORD: ${TAIGA_DB_PASSWORD:-taiga_password}
    volumes:
      - taiga-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${TAIGA_DB_USER:-taiga} -d ${TAIGA_DB_NAME:-taiga}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  taiga-back:
    image: taigaio/taiga-back:latest
    container_name: taiga-back
    environment:
      <<: *taiga-env
      TAIGA_DB_HOST: taiga-db
      TAIGA_EVENTS_HOST: taiga-events
      TAIGA_PROTECTED_HOST: taiga-protected
    volumes:
      - taiga-static-data:/taiga-back/static
      - taiga-media-data:/taiga-back/media
    depends_on:
      taiga-db:
        condition: service_healthy
    restart: unless-stopped

  taiga-async:
    image: taigaio/taiga-back:latest
    container_name: taiga-async
    entrypoint: ["/taiga-back/docker/async_entrypoint.sh"]
    environment:
      <<: *taiga-env
      TAIGA_DB_HOST: taiga-db
      TAIGA_EVENTS_HOST: taiga-events
      TAIGA_PROTECTED_HOST: taiga-protected
    volumes:
      - taiga-static-data:/taiga-back/static
      - taiga-media-data:/taiga-back/media
    depends_on:
      - taiga-back
      - taiga-events-rabbitmq
    restart: unless-stopped

  taiga-front:
    image: taigaio/taiga-front:latest
    container_name: taiga-front
    environment:
      TAIGA_URL: ${TAIGA_SCHEME:-http}://${TAIGA_DOMAIN:-localhost:9000}
      TAIGA_WEBSOCKETS_URL: ws://${TAIGA_DOMAIN:-localhost:9000}
      TAIGA_SUBPATH: ${TAIGA_SUBPATH:-}
      PUBLIC_REGISTER_ENABLED: ${PUBLIC_REGISTER_ENABLED:-False}
    restart: unless-stopped

  taiga-events:
    image: taigaio/taiga-events:latest
    container_name: taiga-events
    environment:
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-taiga}:${RABBITMQ_PASS:-taiga}@taiga-events-rabbitmq:5672/taiga
      TAIGA_SECRET_KEY: ${TAIGA_SECRET_KEY:-taiga-secret-key-change-me}
    depends_on:
      - taiga-events-rabbitmq
    restart: unless-stopped

  taiga-protected:
    image: taigaio/taiga-protected:latest
    container_name: taiga-protected
    environment:
      MAX_AGE: ${PROTECTED_MAX_AGE:-360}
      SECRET_KEY: ${TAIGA_SECRET_KEY:-taiga-secret-key-change-me}
    restart: unless-stopped

  taiga-events-rabbitmq:
    image: rabbitmq:3.12-alpine
    container_name: taiga-events-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-taiga}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASS:-taiga}
      RABBITMQ_DEFAULT_VHOST: taiga
    volumes:
      - taiga-rabbitmq-data:/var/lib/rabbitmq
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  taiga-gateway:
    image: nginx:1.25-alpine
    container_name: taiga-gateway
    ports:
      - "${TAIGA_PORT:-9000}:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - taiga-static-data:/taiga/static:ro
      - taiga-media-data:/taiga/media:ro
    depends_on:
      - taiga-front
      - taiga-back
      - taiga-events
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/api/v1/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped

volumes:
  taiga-db-data:
    name: taiga-db-data
  taiga-static-data:
    name: taiga-static-data
  taiga-media-data:
    name: taiga-media-data
  taiga-rabbitmq-data:
    name: taiga-rabbitmq-data
