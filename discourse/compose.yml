services:
  discourse:
    image: discourse/app
#    build:
#      context: image/discourse_app
#      dockerfile: Dockerfile
    container_name: ${DISCOURSE_CONTAINER_NAME:-discourse_dev}
    ports:
      - "${DISCOURSE_DEV_PORT:-3000}:3000"
      - "${DISCOURSE_HTTP_PORT:-8080}:80"
      - "${DISCOURSE_HTTPS_PORT:-8443}:443"
#    command: ["bash", "-c", "while true; do sleep 1000; done"]
    command: ["rails", "s"]
    entrypoint: ["entrypoint.sh"]
    # env_file:
    #   # - discourse.env
    #   - discourse.dev.env
    environment:
      LC_ALL: en_US.UTF-8
      LANG: en_US.UTF-8
      LANGUAGE: en_US.UTF-8
      RAILS_ENV: production

#      ALLOW_EMPTY_PASSWORD: yes
#      DISCOURSE_EXTERNAL_HTTP_PORT_NUMBER: 3000
      DISCOURSE_HOSTNAME: 'test1.polypia.net'
      DISCOURSE_DEVELOPER_EMAILS:
      DISCOURSE_DB_PORT: 5432
      DISCOURSE_DB_HOST: postgres
      DISCOURSE_DEV_DB: ${POSTGRES_DB:-db01}
      DISCOURSE_DB_NAME: ${POSTGRES_DB:-db01}
      DISCOURSE_DB_USERNAME: ${POSTGRES_USER:-user01}
      DISCOURSE_DB_PASSWORD: ${POSTGRES_PASSWORD:-passw0rd}

      DISCOURSE_REDIS_DB: 0
      DISCOURSE_REDIS_HOST: redis
      DISCOURSE_REDIS_PASSWORD: ${REDIS_PASSWORD:-passw0rd}
      DISCOURSE_REDIS_PORT: 6379
      # DISCOURSE_REDIS_PORT_NUMBER: 6379
      DISCOURSE_REDIS_USE_SSL: false

      # DISCOURSE_DATABASE_HOST: postgres
      # DISCOURSE_DATABASE_PORT_NUMBER: 5432
      # DISCOURSE_DATABASE_USER: user01
      # DISCOURSE_DATABASE_NAME: dev_discourse_db

      # POSTGRESQL_CLIENT_POSTGRES_USER: dev_discourse_user
      # POSTGRESQL_CLIENT_CREATE_DATABASE_NAME: dev_discourse_db
      # POSTGRESQL_CLIENT_CREATE_DATABASE_EXTENSIONS: hstore,pg_trgm
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  postgres:
    image: postgres:16-alpine
    container_name: ${POSTGRES_CONTAINER_NAME:-discourse-postgres}
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-db01}
      POSTGRES_USER: ${POSTGRES_USER:-user01}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-passw0rd}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-user01}"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: ${REDIS_CONTAINER_NAME:-discourse-redis}
    command: redis-server --requirepass ${REDIS_PASSWORD:-passw0rd}
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

volumes:
  postgres_data:
  redis_data:
